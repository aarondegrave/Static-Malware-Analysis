import pefile
import ssdeep
import hashlib
import os
from os import system, name
from datetime import datetime,timezone
from fpdf import FPDF
import math
import json
filetypes = [b'MZ']

def malwaresignature(input_malware):
    malware_file = input_malware
    malware = os.path.basename(malware_file)
    with open(malware_file, 'rb') as f:
        header = f.read(32)
        for call in filetypes:
            if call in header:
                print("Loading...")
                ts = os.path.getctime(malware_file)
                dt = datetime.fromtimestamp(ts, timezone.utc)
                ISO8601 = dt.astimezone().isoformat()
                record = pefile.PE(malware_file)
                fuzzyhash = ssdeep.hash_from_file(malware_file)
                importeddlls = []
                for access in record.DIRECTORY_ENTRY_IMPORT:
                    dlls = access.dll.decode('utf-8')
                    importeddlls.append(dlls)
                arch = record.FILE_HEADER.Machine
                hashmethod = hashlib.sha256()
                with open(malware_file, 'rb') as malwarefile:
                    reader = malwarefile.read()
                    hashmethod.update(reader)
                    hashvalue = hashmethod.hexdigest()
                imphash = record.get_imphash()
                warnings = record.get_warnings()
                nameandSHA = {"Name of sample: ": malware,"Hash Value: " :hashvalue}
                with open ('nameandsha.json', 'w') as k:
                    data = json.dumps(nameandSHA)
                    k.write(data)
                entropy(input_malware)
                entropy(input_malware)
                print("Done")

                return malware_file,ISO8601, hashvalue, arch, importeddlls, imphash, fuzzyhash,warnings


def entropy(input_malware):
    # read the whole file into a byte array
    malware_files = input_malware
    malware = str(malware_files)
    f = open(malware, "rb")
    byteArr = list(f.read())
    f.close()
    fileSize = len(byteArr)
    # calculate the frequency of each byte value in the file
    freqList = []
    for b in range(256):
        ctr = 0
        for byte in byteArr:
            if byte == b:
                ctr += 1
        freqList.append(float(ctr) / fileSize)

    # Shannon entropy
    ent = 0.0
    for freq in freqList:
        if freq > 0:
            ent = ent + freq * math.log(freq, 2)
    ent = -ent
    return ent




def formattedpdf(input_malware,malware_file,ISO8601, hashvalue, arch, importeddlls, imphash, fuzzyhash,warnings):
    malware_file,ISO8601, hashvalue, arch, importeddlls, imphash, fuzzyhash,warnings = malwaresignature(input_malware)
    ent = entropy(input_malware)
    if os.path.isfile(input_malware):
        pdf = FPDF()
        pdf.add_page()
        pdf.set_font("Arial", size=10)
        pdf.cell(200, 10, txt=os.path.basename(malware_file) , ln=1, align="C")
        pdf.cell(0,10,txt="SHA256: " + hashvalue, ln=2, align = "L")
        pdf.cell(0,10, txt="IMPHASH: " + imphash, ln=3, align="L")
        pdf.cell(0,10,txt="Fuzzy: " + fuzzyhash, ln=4, align="L")
        pdf.cell(0,10, txt="Imported dlls: " +', '.join(importeddlls), ln=5, align="L")
        if arch == 332:
            pdf.cell(0,10, txt="Architecture: " + "32-bit binary", ln=6, align="L")
        else:
            pdf.cell(0,10,txt="Architecture: " + "64-bit binary", ln=6, align="L")
        pdf.cell(0,10,txt="Timestamp: " + ISO8601 , ln=7, align="L")
        pdf.cell(0,10,txt="Entropy: " + str(ent), ln=8, align="L")
        pdf.multi_cell(0,10,txt="File warnings: " + (str(warnings).strip('[]')),align="L")
        pdf.output("Sample.pdf")