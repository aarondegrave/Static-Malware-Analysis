from flask import Flask, render_template, request, send_from_directory, redirect
import os
import shutil
from flaskmalwarecheck import malwaresignature
from flaskmalwarecheck import formattedpdf
from flaskmalwarecheck import entropy
import argparse
from elastic import elasticupload

filetypes = [b'MZ']
app= Flask(__name__)
upload_folder = "/home/kali/Downloads/webserverup/"
app.config['UPLOAD_FOLDER']= upload_folder

@app.route('/')
def main():
    return render_template('attempt.html')

@app.route('/upload', methods = ['GET', 'POST'])
def upload():
    try:
        upload_folder = "/home/kali/Downloads/webserverup/"
        app.config['UPLOAD_FOLDER'] = upload_folder
        if request.method == 'POST':
            n = request.files['file']
            filename = n.filename
            print(os.path.realpath(filename))
            with open(filename, 'rb') as f:
                header = f.read(32)
            for call in filetypes:
                if call in header:
                    n.save(filename)
                    shutil.copy(n.filename, upload_folder)
                    os.chdir(upload_folder)
                    malware_file, ISO8601, hashmethod, arch, importeddlls, imphash, fuzzyhash,warnings = malwaresignature(n.filename)
                    formattedpdf(n.filename,malware_file,ISO8601, hashmethod, arch, importeddlls, imphash, fuzzyhash,warnings)
                    download()
                    os.remove(n.filename)
                    os.chdir('..')
                    elasticupload()
                    return redirect('/download', code=302)

            else:
                return redirect('/download', code=302)
    except FileNotFoundError as e:
        return redirect('/download', code=302)

@app.route('/download')
def download():
    return send_from_directory('/home/kali/Downloads/webserverup/','Sample.pdf', as_attachment=True)

def remove():
    if len(os.listdir('/home/kali/Downloads/webserverup')) >= 1:
        os.chdir('/home/kali/Downloads/webserverup')
        os.remove('Sample.pdf')
        os.chdir('..')

@app.route('/transparent')
def transparent():
    with app.open_resource('flaskmalwarecheck.py', 'r') as e:
        contents = e.read()
        return contents


parser = argparse.ArgumentParser()
parser.add_argument("ip", help="Enter host IP", type=str)
parser.add_argument("port", help="Port to be hosted on", type=int)
args = parser.parse_args()
if __name__ == "__main__":
    app.run(host=args.ip, port=args.port)
