__author__ = 'Aaron DeGrave'
import wget
import requests
from bs4 import BeautifulSoup
import os
import zipfile
import argparse


def download_malware(input_location,input_password):

  try:
      os.mkdir(input_location)
  except FileExistsError:
      print("File exists")

  if input_location in os.getcwd():
    os.chdir(os.getcwd() + "/" + input_location)

  else:
    os.chdir(input_location)
  websites = []
  webpages = ['https://mb-api.abuse.ch/downloads/']


  for webpage in webpages:
    a = requests.get(webpage)
    soup = BeautifulSoup(a.text, 'html.parser')

    for link in soup.findAll('a'):
      c = (link.get('href'))
      realwebsite = webpage + c
      websites.append(realwebsite)

    for website in websites:
      if website.endswith('.zip'):
        wget.download(website)
      if input_location in os.getcwd():
        directory = os.listdir(os.getcwd())
      else:
        directory = os.listdir(input_location)
      for filename in directory:
        if filename.endswith('.zip'):
          if input_password:
            try:
              password = input_password
            except RuntimeError as e:
              print("Invalid Password")
              continue
          else:
            password = 'infected'
          with zipfile.ZipFile(filename) as file:
            file.extractall(pwd=bytes(password, 'utf-8'))
        try:
          if filename.endswith('.zip'):
            os.remove(filename)
        except Exception as e:
          print("Unknown Error")


parser = argparse.ArgumentParser()
parser.add_argument("--password", help = "Enter a password default is 'infected'" , type=str)
parser.add_argument("store", help = "Absolute path to hold malware samples.", type=str)
args = parser.parse_args()
download_malware(input_location=args.store, input_password=args.password)