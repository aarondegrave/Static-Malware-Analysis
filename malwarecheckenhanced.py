__author__ = "Aaron DeGrave"
import pefile
import json
import yara
import os
from os import system, name
from termcolor import cprint
from pyfiglet import figlet_format
import time
import argparse
import ssdeep
import pandas as pd
import hashlib
import csv
from fpdf import FPDF
from datetime import datetime,timezone
from pastebin import pastebin
from entropy import entropy

filetypes = [b'MZ']


def _malwaresignature(malware_file, malware):
    global nameandfuzzy
    global hashes
    global warnstring
    global basicfiledata
    with open(malware_file, 'rb') as f:
        header = f.read(32)
        for call in filetypes:
            if call in header:
                ts = os.path.getctime(malware_file)
                dt = datetime.fromtimestamp(ts, timezone.utc)
                ISO8601 = dt.astimezone().isoformat()
                print("Compile Time: " + ISO8601)
                record = pefile.PE(malware_file)
                fuzzyhash = ssdeep.hash_from_file(malware_file)
                nameandfuzzy = {malware: fuzzyhash}
                print("Fuzzy hash of file: " + malware, fuzzyhash)

                access = None
                importeddlls = []
                for access in record.DIRECTORY_ENTRY_IMPORT:
                    dlls = access.dll.decode('utf-8')
                    print(dlls + "\n")
                    importeddlls.append(dlls)
                arch = record.FILE_HEADER.Machine
                if hex(record.FILE_HEADER.Machine) == '0x14c':
                    print("This is a 32-bit binary")
                else:
                    print("This is a 64-bit binary")

                timestamp = (record.FILE_HEADER.dump_dict()['TimeDateStamp']['Value'].split('[')[1][:-1])
                #print("Timestamp " + timestamp)
                for optional in record.OPTIONAL_HEADER.DATA_DIRECTORY:
                    print(optional.name, str(optional.Size), str(optional.VirtualAddress) + '\n')

                hashmethod = hashlib.sha256()
                with open(malware_file, 'rb') as malwarefile:
                    reader = malwarefile.read()
                    hashmethod.update(reader)
                    print("The file name is: ", malware + " The sha256 hash of the file is:", hashmethod.hexdigest())
                imphash = record.get_imphash()
                hashes = {"Name of malware: ": malware, "Imphash:": imphash,
                          "SHA256:": hashmethod.hexdigest()}
                warnings = record.get_warnings()
                warnstring = {"Name of file :": malware, " Warning :": (str(warnings).strip('[]'))}
                basicfiledata = None
                if access:
                    basicfiledata = {"Name of Malware:": malware, "Imported DLLs": importeddlls,
                                     "Arch": record.FILE_HEADER.Machine, "Timestamp": timestamp}
                    print(basicfiledata)
                cprint(figlet_format(
                    "Check the CSV and Json files.",
                    font='digital'), color='green')
        return ISO8601, hashmethod, arch, importeddlls, imphash, fuzzyhash


def getmalwaresignature(input_malware):
    if os.path.isdir(input_malware):
        malwares_files = os.listdir(input_malware)
        for malware in malwares_files:
            malware_file = os.path.join(input_malware, malware)
            _malwaresignature(malware_file, malware)
            entropy(malware_file)
            with open('hashes.json', 'a') as f:
                hashdata = json.dumps(hashes)
                f.write(hashdata + "\n")

            with open('warnings.json', 'a') as f:
                warndata = json.dumps(warnstring)
                f.write(warndata + "\n")

            with open('info.json', 'a') as outfile:
                if basicfiledata:
                    jdata = json.dumps(basicfiledata)
                    hashdata = json.dumps(hashes)
                    outfile.write(jdata + hashdata + "\n")
            with open('fuzzyhashlist.csv', 'a') as e:
                for key in nameandfuzzy.keys():
                    e.write("%s,%s\n" % (key, nameandfuzzy[key]))
    else:
        malware_file = input_malware
        malware = os.path.basename(malware_file)
        _malwaresignature(malware_file, malware)
        ISO8601, hashmethod, arch, importeddlls, imphash, fuzzyhash = _malwaresignature(malware_file,malware)
        formatteddoc(input_malware, malware_file,ISO8601, hashmethod, arch, importeddlls, imphash, fuzzyhash)
        entropy(input_malware)
        #pastebin()


"""Matches samples of malware to yara rules. Can be directory or single sample."""


def _yara_matches(input_rules ,malware_file, rules):
    for rule in rules:
        yara_rule = os.path.join(input_rules, rule)
        if yara_rule.endswith('.yar') or yara_rule.endswith('.yara'):
            yararules = yara.compile(filepath=yara_rule)

            match = []
            matches = yararules.match(malware_file)
            match.append(matches)
            if not matches:
                continue
            else:
                nameofmalware = os.path.basename(malware_file)
                yaramatches = {nameofmalware: matches}
                executivematch = {nameofmalware: matches}
                print(yaramatches)
                with open("examiner.csv", 'a') as m:
                    for key in yaramatches.keys():
                        m.write("%s,%s\n" % (key, yaramatches[key]))

                with open("executive.json", 'a') as e:
                    for key in executivematch.keys():
                        e.write("%s,%s\n" % (key, executivematch[key]))

        else:
            print("That is not a valid rule skipping", yara_rule) or print(
                "That file does not have a valid extension", malware_file)


def yara_matches(input_rules, input_malware):
    if os.path.isfile(input_malware):
        malware_file = input_malware
        rules = os.listdir(input_rules)
        _yara_matches(input_rules, malware_file, rules)

    if os.path.isdir(input_malware):
        rules = os.listdir(input_rules)
        malwares_files = os.listdir(input_malware)
        for malware in malwares_files:
            malware_file = os.path.join(input_malware, malware)
            _yara_matches(input_rules, malware_file, rules)

"""Compares fuzzy hashes of a directory of malwares."""


def fuzzyhashcompare():
    df = pd.read_csv("fuzzyhashlist.csv")
    num = 0
    num2 = -1
    while num < 1:
        while num2 < len(df.FILENAME):
            num2 = num2 + 1
            num = 0
            for fuzzy in df.FUZZYHASH:
                if df.FILENAME[num] == df.FILENAME[num2]:
                    num = num + 1
                    continue
                placeholder = ssdeep.compare(df.FUZZYHASH[num], df.FUZZYHASH[num2])
                examinerfuzzy = {df.FILENAME[num]: df.FILENAME[num2], placeholder: ""}
                with open("examiner.csv", 'a') as m:
                    for key in examinerfuzzy.keys():
                        m.write("%s,%s\n" % (key, examinerfuzzy[key]))

                print("Names of files being compared: " + df.FILENAME[num], df.FILENAME[num2], placeholder)
                num = num + 1

                continue


"""Work in Progess. Will find the name of a malware sample in a prefetch and print cdate and mdate."""


def windows_prefetch(prefetch_data):
    data_prfetch = os.listdir(prefetch_data)
    prefetch_meta = []
    for per in data_prfetch:
        prefetch_file = os.path.join(prefetch_data, per)
        if prefetch_file.endswith(".pf"):
            a = time.ctime(os.path.getctime(prefetch_file))
            b = time.ctime(os.path.getmtime(prefetch_file))
            originaldata = {"File name:": per, "Created time:": a, "Last modified:": b}
            prefetch_meta.append(originaldata)
    with open("prefetchdata.csv", 'a') as m:
        writer = csv.DictWriter(m, ['File name:', "Created time:", "Last modified:"])
        writer.writeheader()
        writer.writerows(prefetch_meta)

    search = os.path.basename(malware_file)
    with open("prefetchdata.csv", 'rt') as f:
        reader = csv.DictReader(f)
        for row in reader:
            if search in row['File name:']:
                print("This sample has been prefetched by windows: " + row['File name:'])
                print("Creation time: " + row["Created time:"])
                print("Modified time: " + row["Last modified:"])


"""Creates a formatted document for a single sample of malware."""


def formatteddoc(input_malware,malware_file,ISO8601, hashmethod, arch, importeddlls, imphash, fuzzyhash):
    ISO8601, hashmethod, arch, importeddlls, imphash, fuzzyhash = _malwaresignature(malware_file, os.path.basename(malware_file))
    if os.path.isfile(input_malware):
        pdf = FPDF()
        pdf.add_page()
        pdf.set_font("Arial", size=12)
        pdf.cell(200, 10, txt=os.path.basename(malware_file) , ln=1, align="C")
        pdf.cell(0,10,txt="SHA256: " + hashmethod.hexdigest(), ln=2, align = "L")
        pdf.cell(0,10, txt="IMPHASH: " + imphash, ln=3, align="L")
        pdf.cell(0,10,txt="Fuzzy: " + fuzzyhash, ln=4, align="L")
        pdf.cell(0,10, txt="Imported dlls: " +', '.join(importeddlls), ln=5, align="L")
        if arch == 332:
            pdf.cell(0,10, txt="Architecture: " + "32-bit binary", ln=6, align="L")
        else:
            pdf.cell(0,10,txt="Architecture: " + "64-bit binary", ln=6, align="L")
        pdf.cell(0,10,txt="Timestamp: " + ISO8601 , ln=7, align="L")
        pdf.output("Sample.pdf")


"""Runs the full program."""


def filesearch(prefetch_data, input_rules, input_malware, removed=None, fuzzycompare=None):
    cprint(figlet_format('Malware Analysis!, Tool is loading...', font='digital'),
           'red', attrs=['bold'])
    time.sleep(1)

    time.sleep(2)
    cprint(figlet_format('Fully Loaded!', font='digital'), 'red', attrs=['bold'])

    if removed:
        listofdocs = ['hashes.json', 'warnings.json', 'prefetchdata.csv', 'info.json', 'fuzzyhashlist.csv', 'executive.json',
                      'examiner.csv', 'managable_data.csv']

        for document in listofdocs:
            f = open(document, "w+")
            f.truncate
            f.close

        fuzzyhash = open("fuzzyhashlist.csv", "w")
        with fuzzyhash:
            fields = ['FILENAME', 'FUZZYHASH']
            writer = csv.DictWriter(fuzzyhash, fieldnames=fields)
            writer.writeheader()
        manage = open("managable_data.csv", "w")
        with manage:
            fields = ['START', 'FILENAME']
            writer = csv.DictWriter(manage, fieldnames=fields)
            writer.writeheader()
    else:
        None

    while True:

        """PE File information directory"""
        try:
            if input_malware:
                getmalwaresignature(input_malware)

        except FileNotFoundError as e:
            print("That file or directory does not exist")
            break

        except IndexError as e:
            print("No more files in the directory")
            break

        except Exception as e:
            print("Unexpected error")
            break

        """Yara rules"""
        try:
            yara_matches(input_rules, input_malware)

        except FileNotFoundError as e:
            print("That file or directory does not exist")
            break
        except IndexError as e:
            print("No more files in the directory" + "\n")
        except TypeError as e:
            print("No specified rule directory")
        except Exception as e:
            print("Unexpected error")
            break

        """Windows prefetch"""
        try:
            windows_prefetch(prefetch_data)

        except FileNotFoundError as e:
            print("That file or directory does not exist")

        except IndexError as e:
            print("No more files in the directory" + "\n")

        except Exception as e:
            print("No prefetch data found")

        """Fuzzy hash compare"""
        if fuzzycompare:
            try:
                fuzzyhashcompare()
            except KeyError as e:
                print("End of Fuzzy file.")
                break
            except IndexError as e:
                print("End of Fuzzy file")
                break
            except Exception as e:
                print("Unknown Error")
                break
        else:
            break


"""All of the arguments that my program takes."""
if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument("--fuzzy", help="Fuzzy hash comparison.", action="store_true")
    parser.add_argument("--remove", help="Removes data from files.", action="store_true")
    parser.add_argument("--rules",
                        help="Point me to a directory with the yara rules.",
                        type=str)
    parser.add_argument("--prefetch", help="Point me to prefetch directory", type=str)
    parser.add_argument("--malware", help="Point me to a directory", type=str)
    args = parser.parse_args()
    filesearch(input_malware=args.malware, input_rules=args.rules, prefetch_data=args.prefetch, fuzzycompare=args.fuzzy, removed=args.remove)

