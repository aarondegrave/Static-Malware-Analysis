__author__ = "Aaron DeGrave"
import pefile
import json
import yara
import os
from os import system, name
from termcolor import cprint
from pyfiglet import figlet_format
import time
import argparse
import ssdeep
import pandas as pd
import hashlib
import csv


def getmalwaresignature(input_malware):

    malwares_files = os.listdir(input_malware)
    for malware in malwares_files:
        malware_file = os.path.join(input_malware, malware)
        if malware_file.endswith('exe') or malware_file.endswith('bin'):
            record = pefile.PE(malware_file)
            fuzzyhash = ssdeep.hash_from_file(malware_file)
            nameandfuzzy = {malware: fuzzyhash}
            print("Fuzzy hash of file: " + malware, fuzzyhash)
            with open('fuzzyhashlist.csv', 'a') as e:
                for key in nameandfuzzy.keys():
                    e.write("%s,%s\n" % (key, nameandfuzzy[key]))

        else:
            print(malware_file + " Not a valid filetype searching next.")
            continue
        access = None
        importeddlls = []
        for access in record.DIRECTORY_ENTRY_IMPORT:
            dlls = access.dll.decode('utf-8')
            print(dlls + "\n")
            importeddlls.append(dlls)
        if hex(record.FILE_HEADER.Machine) == '0x14c':
            print("This is a 32-bit binary")
        else:
            print("This is a 64-bit binary")
        timestamp = (record.FILE_HEADER.dump_dict()['TimeDateStamp']['Value'].split('[')[1][:-1])
        print("Timestamp " + timestamp)
        for optional in record.OPTIONAL_HEADER.DATA_DIRECTORY:
            print(optional.name, str(optional.Size), str(optional.VirtualAddress) + '\n')

        hashmethod = hashlib.sha256()
        with open(malware_file, 'rb') as malwarefile:
            reader = malwarefile.read()
            hashmethod.update(reader)
            print("The file name is: ", malware + " The sha256 hash of the file is:", hashmethod.hexdigest())
        hashes = {"Name of malware: ": malware, "Imphash:": record.get_imphash(), "SHA256:": hashmethod.hexdigest()}
        warnings = record.get_warnings()
        warnstring = {"Name of file :": malware, " Warning :": (str(warnings).strip('[]'))}
        basicfiledata = None
        if access:
            basicfiledata = {"Name of Malware:": malware, "Imported DLLs": importeddlls, "Arch": record.FILE_HEADER.Machine, "Timestamp": timestamp}
            print(basicfiledata)
        cprint(figlet_format(
            "Check the CSV and Json files.",
            font='digital'), color='green')
        with open('hashes.json', 'a') as f:
            hashdata = json.dumps(hashes)
            f.write(hashdata + "\n")

        with open('warnings.json', 'a') as f:
            warndata = json.dumps(warnstring)
            f.write(warndata + "\n")

        with open('info.json', 'a') as outfile:
            if basicfiledata:
                jdata = json.dumps(basicfiledata)
                outfile.write(jdata + "\n")


def yara_matches(input_rules, input_malware):

    rules = os.listdir(input_rules)
    malwares_files = os.listdir(input_malware)
    for malware in malwares_files:
        for rule in rules:
            malware_file = os.path.join(input_malware, malware)

            yara_rule = os.path.join(input_rules, rule)
            try:
                if yara_rule.endswith('.yar') or yara_rule.endswith('.yara'):
                    yararules = yara.compile(filepath=yara_rule)

                    match = []
                    matches = yararules.match(malware_file)
                    match.append(matches)
                    if not matches:
                        continue
                    else:
                        nameofmalware = str(malware)
                        yaramatches = {nameofmalware: matches}
                        executivematch = {nameofmalware: matches}
                        print(yaramatches)
                    with open("examiner.csv", 'a') as m:
                        for key in yaramatches.keys():
                            m.write("%s,%s\n" % (key, yaramatches[key]))

                    with open("executive.json", 'a') as e:
                        for key in executivematch.keys():
                            e.write("%s,%s\n" % (key, executivematch[key]))
                else:
                    print("That is not a valid rule skipping", yara_rule)
            except ValueError as e:
                print("Failed to compile the rule", yara_rule)


def fuzzyhashcompare():
    df = pd.read_csv("fuzzyhashlist.csv")
    num = 0
    num2 = -1
    while num < 1:
        while num2 < len(df.FILENAME):
            num2 = num2 + 1
            num = 0
            for fuzzy in df.FUZZYHASH:
                if df.FILENAME[num] == df.FILENAME[num2]:
                    num = num + 1
                    continue
                placeholder = ssdeep.compare(df.FUZZYHASH[num], df.FUZZYHASH[num2])
                examinerfuzzy = {df.FILENAME[num]: df.FILENAME[num2], placeholder: ""}
                with open("examiner.csv", 'a') as m:
                    for key in examinerfuzzy.keys():
                        m.write("%s,%s\n" % (key, examinerfuzzy[key]))

                print("Names of files being compared: " + df.FILENAME[num], df.FILENAME[num2], placeholder)
                num = num + 1

                continue


def windows_prefetch(prefetch_data, input_malware):
    data_prfetch = os.listdir(prefetch_data)
    for per in data_prfetch:
        prefetch_file = os.path.join(prefetch_data, per)
        if prefetch_file.endswith(".pf"):
            a = time.ctime(os.path.getctime(prefetch_file))
            b = time.ctime(os.path.getmtime(prefetch_file))
            originaldata = {"File name:": per, "Created time:": a, "Last modified:": b}
            simpledata = {"File Name:": per}
            print(originaldata)
            with open("prefetchdata.csv", 'a') as m:
                for key in originaldata.keys():
                    m.write("%s,%s\n" % (key, originaldata[key]))
            with open("managable_data.csv", 'a') as c:
                for key in simpledata.keys():
                    c.write("%s,%s\n" % (key, simpledata[key]))
        else:
            print(prefetch_file + "is not a valid prefetch file")
            continue
"""
        malwares_files = os.listdir(input_malware)
        for malware in malwares_files:
            #malware_file = os.path.join(input_malware, malware)
            search = str(malware)
            df = pd.read_csv("managable_data.csv")
            for filename in df.FILENAME:
                if search in str(filename):
                    print(filename + a + b)
                    break
                else:
                    None
"""
def filesearch(prefetch_data, input_rules, input_malware, removed=None, fuzzycompare=None):
    cprint(figlet_format('Malware Analysis!, Tool is loading...', font='digital'),
           'red', attrs=['bold'])
    time.sleep(3)
    if name == 'nt':
        _ = system('cls')
    else:
        _ = system('clear')
    time.sleep(2)
    cprint(figlet_format('Fully Loaded!', font='digital'), 'red', attrs=['bold'])

    if removed:
        listofdocs = ['hashes.csv', 'warnings.json', 'prefetchdata.csv', 'info.json', 'fuzzyhashlist.csv', 'executive.json',
                      'examiner.csv', 'managable_data.csv']

        for document in listofdocs:
            f = open(document, "w+")
            f.truncate
            f.close

        fuzzyhash = open("fuzzyhashlist.csv", "w")
        with fuzzyhash:
            fields = ['FILENAME', 'FUZZYHASH']
            writer = csv.DictWriter(fuzzyhash, fieldnames=fields)
            writer.writeheader()
        manage = open("managable_data.csv", "w")
        with manage:
            fields = ['START', 'FILENAME']
            writer = csv.DictWriter(manage, fieldnames=fields)
            writer.writeheader()
    else:
        None

    while True:
        """PE File information"""
        try:
            getmalwaresignature(input_malware)

        except FileNotFoundError as e:
            print("That file or directory does not exist")
            break

        except IndexError as e:
            print("No more files in the directory")
            break

        except Exception as e:
            print("Unexpected error")
            break

        """Yara rules"""
        try:
            yara_matches(input_rules, input_malware)

        except FileNotFoundError as e:
            print("That file or directory does not exist")
            break
        except IndexError as e:
            print("No more files in the directory" + "\n")

        except Exception as e:
            print("Unexpected error")
            break

        """Windows prefetch"""
        try:
            windows_prefetch(prefetch_data,input_malware)

        except FileNotFoundError as e:
            print("That file or directory does not exist")

        except IndexError as e:
            print("No more files in the directory" + "\n")

        except Exception as e:
            print("Unexpected Error")
            break

        """Fuzzy hash compare"""
        if fuzzycompare:
            try:
                fuzzyhashcompare()
            except KeyError as e:
                print("End of Fuzzy file.")
                break
            except IndexError as e:
                print("End of Fuzzy file")
                break
            except Exception as e:
                print("Unknown Error")
                break


parser = argparse.ArgumentParser()
parser.add_argument("--fuzzy", help="Fuzzy hash comparison.", action="store_true")
parser.add_argument("--remove", help="Removes data from files.", action="store_true")
parser.add_argument("--rules",
                    help="Point me to a directory with the yara rules.",
                    type=str)
parser.add_argument("--prefetch", help="Point me to prefetch directory", type=str)
parser.add_argument("malware", help="Point me to a directory", type=str)
args = parser.parse_args()
filesearch(input_malware=args.malware, input_rules=args.rules, prefetch_data=args.prefetch, fuzzycompare=args.fuzzy, removed=args.remove)
