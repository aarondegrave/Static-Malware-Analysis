"""STATIC Malware analysis Tool created by Aaron DeGrave"""
import pefile
import json
import yara
import os
from os import system, name
from termcolor import cprint
from pyfiglet import figlet_format
import time
import argparse



def filesearch():
    parser = argparse.ArgumentParser()
    parser.add_argument("--remove", help="type remove to remove all prior saved file data.", type=str)
    parser.add_argument("rules",
                        help="Point me to a directory with the yara rules. EXAMPLE: /home/kali/yara_repo/testdir/ make sure to add the last /",
                        type=str)
    parser.add_argument("file", help="Point me to a directory with malware", type=str)
    args = parser.parse_args()
    cprint(figlet_format('Malware Analysis!, Tool is loading...', font='digital'),
           'red', attrs=['bold'])
    time.sleep(4)
    if name == 'nt':
        _ = system('cls')
    else:
        _ = system('clear')
    time.sleep(2)
    cprint(figlet_format('Fully Loaded!', font='digital'), 'red', attrs=['bold'])

    if type(args.remove) is str:
        f = open('hashes.csv', "w+")
        f.truncate()
        f.close()
        c = open('warnings.csv', "w+")
        c.truncate()
        c.close()
        i = open('info.txt', "w+")
        i.truncate()
        i.close()
    else:
        None
    while True:
        """PE File information"""
        try:
            num2 = 0
            malwares = os.listdir(args.file)
            while num2 < len(malwares):
                for malware in malwares:
                    record = pefile.PE(args.file + malwares[num2])
                    basicfiledata = {}
                    for access in record.DIRECTORY_ENTRY_IMPORT:
                        print(access.dll.decode('utf-8') + "\n")
                    if hex(record.FILE_HEADER.Machine) == '0x14c':
                        print("This is a 32-bit binary")
                    else:
                        print("This is a 64-bit binary")
                    timestamp = (record.FILE_HEADER.dump_dict()['TimeDateStamp']['Value'].split('[')[1][:-1])
                    print("Timestamp " + timestamp)
                    DEShash = hash(record)

                    hashes = {record.get_imphash(): DEShash}
                    warnings = record.get_warnings()
                    warnstring = {(str(warnings).strip('[]')): " "}
                    basicfiledata = {access.dll.decode('utf-8'): record.FILE_HEADER.Machine, timestamp: " "}
                    print(basicfiledata)
                    cprint(figlet_format(
                        "Make sure to check the csv files and the txt file. More useful infmoration could be in there.",
                        font='digital'), color='green')
                    with open('hashes.csv', 'a') as f:
                        for key in hashes.keys():
                            f.write("%s,%s\n" % (key, hashes[key]))

                    with open('warnings.csv', 'a') as f:
                        for key in warnstring.keys():
                            f.write("%s,%s\n" % (key, warnstring[key]))

                    with open('info.txt', 'a') as outfile:
                        json.dump(basicfiledata, outfile)
                    num2 = num2 + 1
                    print(num2)
                    continue


        except (FileNotFoundError, IndexError) as e:
            if FileNotFoundError:
                print("That file does not exist")
                break
            elif IndexError:
                print("Scanned all files in the directory")
                break
            else:
                print("Unexpected Error")
                break

        """Yara rules"""
        try:
            num = 0
            num2 = 0
            rules = os.listdir(args.rules)

            while num < len(rules):

                for rule in rules:

                    yopen = open(args.rules + rules[num])
                    yararules = yara.compile(file=yopen)


                    """I'm not entirely sure that all of the yara files are being put against the malware."""
                    matches = yararules.match(args.file + malwares[num2], timeout=10)
                    nameofmalware = str(malwares[num2])
                    num = num + 1
                    num2 = num2 + 1

                    """Doesn't print correctly, some files should have more than 1 hit."""
                    print(nameofmalware, matches)
                    print(num)
                    continue



        except (FileNotFoundError, IndexError) as e:
            if FileNotFoundError:
                print("That file or directory does not exist")
                break
            elif IndexError:
                print("No more files in the directory")
                break
            else:
                print("Unexpected error")
                break
        break


filesearch()
