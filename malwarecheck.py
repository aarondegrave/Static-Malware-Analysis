###STATIC Malware analysis Tool created by Aaron DeGrave
import pefile
import json
import yara
from os import system, name
from termcolor import cprint
from pyfiglet import figlet_format
import time
import argparse



def filesearch():

  parser = argparse.ArgumentParser()
  parser.add_argument("--remove", help="type remove to remove all prior saved file data.", type=str)
  parser.add_argument("rules", help= "what is the path to the yara rules?", type=str)
  parser.add_argument("file", help = "What is the name of the file? Include the extension",type=str)
  args = parser.parse_args()
  cprint(figlet_format('Malware Analysis!, Tool is loading...', font='digital'),
       'red', attrs=['bold'])
  time.sleep(4)
  if name == 'nt':
    _ = system('cls')
  else:
    _ = system('clear')
  time.sleep(2)
  cprint(figlet_format('Fully Loaded!', font = 'digital'), 'red', attrs=['bold'])




  if args.remove == "remove":
     f = open('hashes.csv', "w+")
     f.truncate()
     f.close()
     c = open('warnings.csv', "w+")
     c.truncate()
     c.close()
     i = open('info.txt', "w+")
     i.truncate()
     i.close()
  else:
     None
  while True:
# Yara rules
    try:
      yopen = open(args.rules)
      rules = yara.compile(file=yopen)
    except FileNotFoundError as e:
      print("That file or directory does not exist")
# PEfile data
    try:
      record = pefile.PE(args.file)
      basicfiledata = {}
      matches = rules.match(args.file, timeout=60)
      print(matches)
    except FileNotFoundError as e:
      print("That file does not exist")

    #Stack Overflow
    for access in record.DIRECTORY_ENTRY_IMPORT:
      print(access.dll.decode('utf-8') + "\n")
  
    #BufferOverflows exploring PE files with python 
    if hex(record.FILE_HEADER.Machine) == '0x14c':
      print("This is a 32-bit binary")
    else:
      print("This is a 64-bit binary")
    
    timestamp =(record.FILE_HEADER.dump_dict()['TimeDateStamp']['Value'].split('[')[1][:-1])
    print("Timestamp " + timestamp )
    DEShash = hash(record)

    hashes = {record.get_imphash(): DEShash}
    warnings = record.get_warnings()
    warnstring= {(str(warnings).strip('[]')): matches}
  
    basicfiledata = {access.dll.decode('utf-8'): record.FILE_HEADER.Machine,timestamp: " "}
    print(basicfiledata)
    cprint(figlet_format("Make sure to check the csv files and the txt file. More useful infmoration could be in there.", font = 'digital'), color='green')


# Save data

    with open ('hashes.csv', 'a') as f:
        for key in hashes.keys():
          f.write("%s,%s\n"%(key,hashes[key]))

    with open ('warnings.csv', 'a') as f:
      for key in warnstring.keys():
        f.write("%s,%s\n"%(key,warnstring[key]))
    
    with open ('info.txt', 'a') as outfile:
      json.dump(basicfiledata, outfile)
    break





filesearch()

