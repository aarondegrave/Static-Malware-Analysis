"""STATIC Malware analysis Tool created by Aaron DeGrave"""
import pefile
import json
import yara
import os
from os import system, name
from termcolor import cprint
from pyfiglet import figlet_format
import time
import argparse

def filesearch(input_rules, input_malware, removed = None):
    cprint(figlet_format('Malware Analysis!, Tool is loading...', font='digital'),
           'red', attrs=['bold'])
    time.sleep(4)
    if name == 'nt':
        _ = system('cls')
    else:
        _ = system('clear')
    time.sleep(2)
    cprint(figlet_format('Fully Loaded!', font='digital'), 'red', attrs=['bold'])

    if removed:
        f = open('hashes.csv', "w+")
        f.truncate()
        f.close()
        c = open('warnings.csv', "w+")
        c.truncate()
        c.close()
        m = open('examiner.csv', "w+")
        m.truncate()
        m.close()
        i = open('info.txt', "w+")
        i.truncate()
        i.close()
        z = open("executive.csv", "w+")
        z.truncate()
        z.close()
    else:
        None
    while True:
        """PE File information"""
        try:
            num2 = 0
            malwares = os.listdir(input_malware)
            while num2 < len(malwares):
                for malware in malwares:
                    malware_file = os.path.join(input_malware, malwares[num2])
                    if malware_file.endswith('exe') or malware_file.endswith('bin'):
                        record = pefile.PE(malware_file)
                    else:
                        print(malware_file + " Not a valid filetype searching next.")
                        num2 = num2 + 1
                        continue
                    basicfiledata = {}
                    for access in record.DIRECTORY_ENTRY_IMPORT:
                        print(access.dll.decode('utf-8') + "\n")
                    if hex(record.FILE_HEADER.Machine) == '0x14c':
                        print("This is a 32-bit binary")
                    else:
                        print("This is a 64-bit binary")
                    timestamp = (record.FILE_HEADER.dump_dict()['TimeDateStamp']['Value'].split('[')[1][:-1])
                    print("Timestamp " + timestamp)
                    DEShash = hash(record)
                    hashes = {record.get_imphash(): DEShash}
                    warnings = record.get_warnings()
                    warnstring = {(str(warnings).strip('[]')): " "}
                    basicfiledata = {access.dll.decode('utf-8'): record.FILE_HEADER.Machine, timestamp: " "}
                    print(basicfiledata)
                    cprint(figlet_format(
                        "Make sure to check the csv files and the txt file. More useful infmoration could be in there.",
                        font='digital'), color='green')
                    with open('hashes.csv', 'a') as f:
                        for key in hashes.keys():
                            f.write("%s,%s\n" % (key, hashes[key]))

                    with open('warnings.csv', 'a') as f:
                        for key in warnstring.keys():
                            f.write("%s,%s\n" % (key, warnstring[key]))

                    with open('info.txt', 'a') as outfile:
                        json.dump(basicfiledata, outfile)
                    num2 = num2 + 1
                    continue

        except FileNotFoundError as e:
            print("That file or directory does not exist")
            break

        except IndexError as e:
            print("No more files in the directory")
            break

        except Exception as e:
            print("Unexpected error")
            break

        """Yara rules"""
        try:
            num = 0
            num2 = -1

            rules = os.listdir(input_rules)
            while num < len(rules):
                while num2 < len(malwares):
                    num2 = num2 + 1
                    num = 0
                    for rule in rules:
                        yara_rule = os.path.join(input_rules, rules[num])
                        try:
                            if yara_rule.endswith('.yar') or yara_rule.endswith('.yara'):
                                yararules = yara.compile(filepath=yara_rule)
                            else:
                                print("That is not a valid rule skipping", yara_rule)
                                num = num + 1
                                continue
                        except ValueError as e:
                            print("Failed to compile the rule", yara_rule)
                            num = num + 1
                            continue
                        matches = yararules.match(os.path.join(input_malware, malwares[num2]))
                        nameofmalware = str(malwares[num2])
                        num = num + 1
                        yaramatches = {nameofmalware:matches}
                        executivematch = {nameofmalware: matches}

                        print(yaramatches)


                        with open("examiner.csv", 'a') as m:
                            for key in yaramatches.keys():
                                m.write("%s,%s\n" % (key, yaramatches[key]))

                        with open("executive.csv", 'a') as e:
                            for key in executivematch.keys():
                                e.write("%s,%s\n" % (key, executivematch[key]))


                continue

        except FileNotFoundError as e:
            print("That file or directory does not exist")
            break
        except IndexError as e:
            print("No more files in the directory")
            break
        except Exception as e:
            print("Unexpected error")
            break
        break
parser = argparse.ArgumentParser()
parser.add_argument("--remove", help="type remove to remove all prior saved file data.", action="store_true")
parser.add_argument("rules",
                    help="Point me to a directory with the yara rules.",
                    type=str)
parser.add_argument("malware", help="Point me to a directory with malware", type=str)
args = parser.parse_args()


filesearch(input_rules=args.rules, input_malware=args.malware,removed=args.remove)
