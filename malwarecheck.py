###STATIC Malware analysis Tool created by Aaron DeGrave
import pefile
import json
import yara
from os import system, name
from termcolor import cprint
from pyfiglet import figlet_format
import time

def filesearch():
  cprint(figlet_format('Malware Analysis!, Tool is loading...', font='digital'),
       'red', attrs=['bold'])
  time.sleep(4)
  if name == 'nt':
    _ = system('cls')
  else:
    _ = system('clear')
  time.sleep(2)
  cprint(figlet_format('Fully Loaded!', font = 'digital'), 'red', attrs=['bold'])
  clear = input("Would you like to clear prior csv file data? (y/n)")
  clear.lower()
  if clear == "y":
     f = open('hashes.csv', "w+")
     f.truncate()
     f.close()
     c = open('warnings.csv', "w+")
     c.truncate()
     c.close()
     i = open('info.txt', "w+")
     i.truncate()
     i.close()
  else:
     None
  while True:
# Yara rules
    ask = input("What is the path to the rules? ")
    try:
      yopen = open(ask)
      rules = yara.compile(file=yopen)
    except FileNotFoundError as e:
      print("That file or directory does not exist")
      continue
# PEfile data
    try:
      h = input("What is the name of the file? Include extension ")
      record = pefile.PE(h)
      basicfiledata = {}
      matches = rules.match(h, timeout=60)
      print(matches)
    except FileNotFoundError as e:
      print("That file does not exist")
      continue

    #Stack Overflow
    for access in record.DIRECTORY_ENTRY_IMPORT:
      print(access.dll.decode('utf-8') + "\n")
  
    #BufferOverflows exploring PE files with python 
    if hex(record.FILE_HEADER.Machine) == '0x14c':
      print("This is a 32-bit binary")
    else:
      print("This is a 64-bit binary")
    
    timestamp =(record.FILE_HEADER.dump_dict()['TimeDateStamp']['Value'].split('[')[1][:-1])
    print("Timestamp " + timestamp )
    DEShash = hash(record)

    hashes = {record.get_imphash(): DEShash}
    warnings = record.get_warnings()
    warnstring= {(str(warnings).strip('[]')): matches}
  
    basicfiledata = {access.dll.decode('utf-8'): record.FILE_HEADER.Machine,timestamp: " "}
    print(basicfiledata)
    cprint(figlet_format("Make sure to check the csv files and the txt file. More useful infmoration could be in there.", font = 'digital'), color='green')


# Save data

    with open ('hashes.csv', 'a') as f:
        for key in hashes.keys():
          f.write("%s,%s\n"%(key,hashes[key]))

    with open ('warnings.csv', 'a') as f:
      for key in warnstring.keys():
        f.write("%s,%s\n"%(key,warnstring[key]))
    
    with open ('info.txt', 'a') as outfile:
      json.dump(basicfiledata, outfile)
    break





filesearch()

